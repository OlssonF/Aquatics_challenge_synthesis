---
title: "figures?"
output: html_document
date: "2023-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(arrow)
library(lubridate)
library(tidytext)
library(ggpattern)
```

## Read in the data and model metadata

```{r read-in-data}

lake_sites <- c('BARC', 'CRAM', 'LIRO', 'PRLA', 'PRPO', 'SUGG', 'TOOK')
cols_modeltype <- c('empirical' = "#482576FF",
                    'multi-model ensemble' =  "#35608DFF",
                    'process' = "#21908CFF",
                    'ML' = '#BBDF27FF',
                    'null' = '#43BF71FF')
# read in the metadata from the google sheet
googlesheets4::gs4_deauth()
model_meta <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1oC7_w63wSCXNiHs1IK8AFGr0MG-NdjDAjwkfjvRZW-I/edit?usp=sharing")

# Open dataset-------------
# start with lake temperatures
temperature_scores <- arrow::open_dataset("../scores_rescored") |>
  filter(site_id %in% lake_sites,
         # model_id != 'climatology',
         model_id %in% model_meta$model_id,
         variable == 'temperature') |>
  collect()


# Calculate skill scores ------------
temperature_climatology <- arrow::open_dataset("../scores_rescored") |>
  filter(model_id == 'climatology', 
         site_id %in% lake_sites,
         variable == 'temperature') |>
  collect() |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  arrange(reference_datetime, datetime, site_id) |> 
  pivot_wider(values_from = c(crps, logs),
              names_from = model_id)

temperature_skill <- temperature_scores |>
  filter(model_id != 'climatology') |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  full_join(temperature_climatology) |> 
  
  # calcaulte the skill relative to climatology (- is bad, + is good)
  mutate(skill_crps = 1 - (crps/crps_climatology),
         skill_logs = 1 - (logs/logs_climatology),
         horizon = as.numeric(as_date(datetime) - as_date(reference_datetime))) |> 
  # consistent forecast period
  filter(horizon <= 30,
         horizon >= 1,
         model_id != 'fARIMA') |> 
  arrange(reference_datetime, site_id, datetime, model_id) 
```

## Figure 1

Top 10 models and all models coloured by type and showing if they include covariates or not. 
```{r model-type, fig.width=10}
top10_temp <- 
  temperature_skill |> 
  group_by(model_id) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  ungroup() |>
  slice_max(mean_crps, n= 10, na_rm = T) |>
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, mean_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=mean_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.04,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model', x = 'mean CRPS skill (vs climatology)') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe')) +
  scale_pattern_type_manual(values=c(NA, NA)) +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white", pattern_spacing = 0.02), 
                                title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

all_temp <- 
  temperature_skill |> 
  group_by(model_id) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, mean_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=mean_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  # geom_rect(aes(ymin = 'flareGOTM_noDA', 
  #               ymax ='flareGLM', 
  #               xmin = -Inf, 
  #               xmax = Inf)) +
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.03,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model', x = 'mean CRPS skill (vs climatology)') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe'), name = 'Uses weather covariates?') +
  scale_pattern_type_manual(values=c(NA, NA), name = 'Uses weather covariates?') +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white"), title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

ggpubr::ggarrange(top10_temp, all_temp, nrow = 1, align = 'hv',
                  common.legend = T,
                  legend = 'top', labels = 'auto') |> 
  ggsave(filename = './Plots/Figure1.png', width = 25, height = 10, units = 'cm')

```

9 of 10 top 10 models use covariates, and process models and ML are the most common best performers. 
There are a lot of really bad empirical models.

## Figure 2
How does model type performance, on avergae, differ by site. 

This uses all model_ids (maybe get rid of the 'worst') performers. 

```{r model_type-site}
clim_mean <- temperature_climatology |> 
  group_by(site_id) |> 
  summarise(mean_score = mean(crps_climatology, na.rm = T))  |> 
  arrange(mean_score)

n_model_type <- temperature_skill |> 
  distinct(model_id) |> 
  left_join(model_meta) |>
  group_by(model_type) |> 
  summarise(n = n())  |> 
  mutate(site_id = 'TOOK', mean_skill = -3.5) |> 
  filter(model_type != 'null')

(temperature_skill |> 
  left_join(model_meta, by = 'model_id') |>
  filter(model_type != 'null') |> 
  group_by(model_type, model_id, site_id) |> 
  summarise(mean_skill = mean(skill_crps, na.rm = T)) |>  
  ggplot(aes(x = mean_skill, 
             y = site_id, 
             colour = model_type)) +
  geom_vline(xintercept = 0, linetype = 'solid') +
  geom_label(data = n_model_type, aes(label = paste0('n = ', n)))+ 
  # geom_point(data = clim_mean, aes(x = mean_score, y = site_id), colour = 'black') +
  geom_boxplot() +
  facet_wrap(~model_type, scales = 'free_y',nrow = 4) +
  labs(y='Site', x = 'mean CRPS skill (vs climatology)') +
  scale_colour_manual(values = cols_modeltype) +
  theme_bw()) |> 
  ggsave(filename = './Plots/Figure2.png', width = 15, height = 15, units = 'cm')

```

Gains at PRLA and PRPO relative to climatology (these have the worst climatology - see table), especially using process-models and ML.

The best climatology sites (BARC, SUGG) are difficult to beat even though perform well overall. 

## Figure 3
How does the performance vary across horizon? 
Do the models perform better consistently across the horizon at each site?
How do the best performing individual models perform?

```{r horizon-score}
# top 10 average models
top_mods <- temperature_skill |> 
  group_by(model_id) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  ungroup() |> 
  slice_max(mean_crps, n = 10, na_rm = T) |> 
  distinct(model_id)

A <- temperature_skill |> 
  filter(model_id %in% top_mods$model_id) |> 
  group_by(site_id, horizon) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  ggplot(aes(x=horizon, 
             y = mean_crps, colour = site_id)) +
  geom_hline(yintercept = 0) + 
  geom_line()  +  
  labs(y='mean CRPS skill (vs climatology)', x = 'Horizon (days)') +
  scale_color_viridis_d(option = 'H') +
  theme_bw()

B <- temperature_skill |> 
  filter(model_id %in% top_mods$model_id) |> 
  group_by(model_id, horizon) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  ggplot(aes(x=horizon, 
             y = mean_crps, colour = model_id)) +
  geom_hline(yintercept = 0) + 
  geom_line()  +  
  labs(y='mean CRPS skill (vs climatology)', x = 'Horizon (days)') +
  scale_color_viridis_d(option = 'A', begin = 0.1, end =0.9, name = 'Model') +
  theme_bw()

ggpubr::ggarrange(A, B, labels = 'auto', align = 'v', nrow = 2) |> 
  ggsave(filename = 'Plots/Figure3.png', width = 15, height = 17, units = 'cm')
```

Models beeating climatology at the shorter horizons (as expected) PRLA and PRPO always better than climatology.

Individual model performance decreases relative to climatology mostly except for random forest and lasso regression which improve after short horizons (may be related to the precision rather than accuracy). Less degradation in performance of ML models across the horizon (xgboost and random forest) than process models. 

### How much is uncertainty?

How does the sd vary - is this my some see a increase in crps skill? 

```{r horizon-score}
# top 10 average models
top_mods <- temperature_skill |> 
  group_by(model_id) |> 
  summarise(mean_crps = mean(skill_crps, na.rm = T)) |> 
  ungroup() |> 
  slice_max(mean_crps, n = 10, na_rm = T) |> 
  distinct(model_id)

sd <- temperature_scores |> 
  mutate(horizon = as_date(datetime) - as_date(reference_datetime)) |> 
  filter(model_id %in% top_mods$model_id, 
         horizon > 0, 
         horizon <=30) |>
  group_by(model_id, horizon) |> 
  summarise(mean_sd = mean(sd, na.rm = T)) |> 
  ggplot(aes(x=horizon, 
             y = mean_sd, colour = model_id)) +
  geom_line()  +  
  labs(y='mean standard deviation', x = 'Horizon (days)') +
  scale_color_viridis_d(option = 'A', begin = 0.1, end =0.9) +
  theme_bw()

bias <- temperature_scores |> 
  mutate(horizon = as_date(datetime) - as_date(reference_datetime),
         abs_bias = abs(mean - observation)) |> 
  filter(model_id %in% top_mods$model_id, 
         horizon > 0, 
         horizon <=30) |>
  group_by(model_id, horizon) |> 
  summarise(mean_abs_bias = mean(abs_bias, na.rm = T)) |> 
  ggplot(aes(x=horizon, 
             y = mean_abs_bias, colour = model_id)) +
  geom_line()  +  
  labs(y='mean absolute bias', x = 'Horizon (days)') +
  scale_color_viridis_d(option = 'A', begin = 0.1, end =0.9) +
  theme_bw() +
  coord_cartesian(ylim = c(0, 2.5))

ggpubr::ggarrange(sd, bias, labels = 'auto', align = 'v', nrow = 2) |> 
  ggsave(filename = 'Plots/Figure4.png')
```

## Figure 4 - NOAA scores

can this be related to the weather forecasts?

There is only one month when the observations overlap for the observational data...
But still the performance is better vs the observations than the stage 3

```{r}
NOAA_scores <- arrow::open_dataset("../scores") |>
  filter(site_id %in% lake_sites,
         model_id %in% c('NOAA_daily', 'NOAA_daily_obs')) |>
  collect()

NOAA_scores |> 
  mutate(horizon = as_date(datetime) - as_date(reference_datetime)) |> 
  select(site_id, crps, horizon, reference_datetime, model_id) |> 
  pivot_wider(names_from = site_id, values_from = crps, id_cols = horizon:model_id) |> 
  filter(reference_datetime > as_date('2023-05-25'),
         reference_datetime < as_date('2023-07-31')) |> 
  # only a 1 month overlap....
  pivot_longer(cols = BARC:TOOK, names_to = 'site_id', values_to = 'crps') |> 
  group_by(model_id, site_id, horizon) |> 
  summarise(mean_crps = mean(crps, na.rm = T)) |> 
  filter(horizon <= 30) |> 
  ggplot(aes(x=horizon, y=mean_crps, colour = model_id)) +
  geom_line() +
  facet_wrap(~site_id) +
  theme_bw() +
  labs(y = 'CRPS score (oC)', title = 'NOAA air temperature forecast')


```

## site differences in observations?

```{r obs-cv}
temperature_scores |> 
  mutate(horizon = as.numeric(as_date(datetime) - as_date(reference_datetime))) |> 
  filter(between(horizon, 0,30)) |> 
  group_by(site_id, variable, horizon) |> 
  summarise(cv = sd(observation, na.rm = T)/ mean(observation, na.rm = T)) |> 
  ggplot(aes(x=horizon, y= cv, colour = site_id)) +
  geom_point() +
  scale_colour_viridis_d(option = 'turbo') +
  theme_bw()
```


## Supplementary figures

```{r echo = F}
temperature_skill |> 
  left_join(model_meta, by = 'model_id') |>
  filter(model_type != 'null') |> 
  group_by(model_type, model_id, site_id) |> 
  summarise(mean_skill = mean(skill_crps, na.rm = T)) |>  
  ggplot(aes(x = mean_skill, 
             y = site_id, 
             colour = model_type)) +
  geom_vline(xintercept = 0, linetype = 'dashed') +
  geom_boxplot() +
  facet_wrap(~model_type, scales = 'free_y',nrow = 4) +
  labs(y='model_id', x = 'mean CRPS score', title = 'all dates') +
  scale_colour_manual(values = cols_modeltype) +
  theme_bw() 

temperature_skill |> 
  left_join(model_meta, by = 'model_id') |>
  filter(model_type != 'null',
         reference_datetime > as_date('2023-06-28'),
         reference_datetime < as_date('2023-09-18')) |> 
  group_by(model_type, model_id, site_id) |> 
  summarise(mean_skill = mean(skill_crps, na.rm = T)) |>  
  ggplot(aes(x = mean_skill, 
             y = site_id, 
             colour = model_type)) +
  geom_vline(xintercept = 0, linetype = 'dashed') +
  geom_boxplot() +
  facet_wrap(~model_type, scales = 'free_y',nrow = 4) +
  labs(y='model_id', x = 'mean CRPS score', title = 'overlapping only') +
  scale_colour_manual(values = cols_modeltype) +
  theme_bw() 
```


## Chlorophyll and oxygen patterns same?

```{r read-WQ, echo = F}
# Open dataset-------------
chla_scores <- arrow::open_dataset("../scores_rescored") |>
  filter(site_id %in% lake_sites,
         # model_id != 'climatology',
         model_id %in% model_meta$model_id,
         variable == 'chla') |>
  collect()

# Calculate skill scores ------------
chla_persistence <- arrow::open_dataset("../scores_rescored") |>
  filter(model_id == 'persistenceRW', 
         site_id %in% lake_sites,
         variable == 'chla') |>
  collect() |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  arrange(reference_datetime, datetime, site_id) |> 
  pivot_wider(values_from = c(crps, logs),
              names_from = model_id)

chla_skill <- chla_scores |>
  filter(model_id != 'persistenceRW') |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  full_join(chla_persistence) |> 
  
  # calcaulte the skill relative to persistence (- is bad, + is good)
  mutate(skill_crps = crps_persistenceRW - crps,
         skill_logs = logs_persistenceRW - logs,
         horizon = as.numeric(as_date(datetime) - as_date(reference_datetime))) |> 
  # consistent forecast period
  filter(horizon <= 30,
         horizon >= 1,
         model_id != 'fARIMA') |> 
  arrange(reference_datetime, site_id, datetime, model_id) 

#--------------------------------------#
# Dissolved oxygen

# Open dataset-------------
oxygen_scores <- arrow::open_dataset("../scores_rescored") |>
  filter(site_id %in% lake_sites,
         # model_id != 'climatology',
         model_id %in% model_meta$model_id,
         variable == 'oxygen') |>
  collect()

# Calculate skill scores ------------
oxygen_climatology <- arrow::open_dataset("../scores_rescored") |>
  filter(model_id == 'climatology', 
         site_id %in% lake_sites,
         variable == 'oxygen') |>
  collect() |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  arrange(reference_datetime, datetime, site_id) |> 
  pivot_wider(values_from = c(crps, logs),
              names_from = model_id)

oxygen_skill <- oxygen_scores |>
  filter(model_id != 'climatology') |> 
  select(reference_datetime, datetime, crps, logs, site_id, model_id) |> 
  full_join(oxygen_climatology) |> 
  
  # calcaulte the skill relative to persistence (- is bad, + is good)
  mutate(skill_crps = crps_climatology - crps,
         skill_logs = logs_climatology - logs,
         horizon = as.numeric(as_date(datetime) - as_date(reference_datetime))) |> 
  # consistent forecast period
  filter(horizon <= 30,
         horizon >= 1,
         model_id != 'fARIMA') |> 
  arrange(reference_datetime, site_id, datetime, model_id) 

#--------------------------------------#
```

```{r plot-WQ, echo = F}

top10_chla <- 
  chla_skill |> 
  group_by(model_id) |> 
  summarise(median_crps = median(skill_crps, na.rm = T)) |> 
  ungroup() |>
  slice_max(median_crps, n= 10, na_rm = T) |>
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, median_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=median_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.04,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model ID', x = 'median CRPS skill (vs climatology)', title = 'chla') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe')) +
  scale_pattern_type_manual(values=c(NA, NA)) +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white", pattern_spacing = 0.02), 
                                title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

all_chla <- chla_skill |> 
  group_by(model_id) |> 
  summarise(median_crps = median(skill_crps, na.rm = T)) |> 
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, median_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=median_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.03,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model ID', x = 'median CRPS skill (vs persistence)') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe'), name = 'Uses weather covariates?') +
  scale_pattern_type_manual(values=c(NA, NA), name = 'Uses weather covariates?') +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white"), title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

ggpubr::ggarrange(top10_chla, all_chla, nrow = 1, 
                  common.legend = T,align = 'h', 
                  legend = 'top', labels = 'auto')

#---------------------------------------------------#

top10_oxygen <- 
  oxygen_skill |> 
  group_by(model_id) |> 
  summarise(median_crps = median(skill_crps, na.rm = T)) |> 
  ungroup() |>
  slice_max(median_crps, n= 10, na_rm = T) |>
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, median_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=median_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.04,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model ID', x = 'median CRPS skill (vs climatology)', title = 'oxygen') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe')) +
  scale_pattern_type_manual(values=c(NA, NA)) +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white", pattern_spacing = 0.02), 
                                title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

all_oxygen <- oxygen_skill |> 
  group_by(model_id) |> 
  summarise(median_crps = median(skill_crps, na.rm = T)) |> 
  left_join(model_meta) |> 
  mutate(model_id = fct_reorder(model_id, median_crps),
         uses_NOAA = ifelse(uses_NOAA == 1, 'yes', 'no')) |> 
  ggplot(aes(x=median_crps, y = model_id, fill = model_type)) +    # Different pattern for each group
  geom_bar_pattern(aes(pattern = as.factor(uses_NOAA)),
                   stat = "identity",
                   alpha = 0.8, 
                   pattern_fill = "black",
                   colour = "black", 
                   pattern_spacing = 0.03,
                   pattern_alpha = 1) + 
  scale_y_reordered() +
  labs(y='Model ID', x = 'median CRPS skill (vs climatology)') +
  geom_vline(xintercept = 0) +
  scale_fill_manual(values = cols_modeltype) +
  scale_pattern_manual(values=c('none', 'stripe'), name = 'Uses weather covariates?') +
  scale_pattern_type_manual(values=c(NA, NA), name = 'Uses weather covariates?') +
  theme_bw() + 
  guides(pattern = guide_legend(override.aes = list(fill = "white"), title = 'Uses weather covariates?'),
         fill = guide_legend(override.aes = list(pattern = "none"), title = 'Model type'))

ggpubr::ggarrange(top10_oxygen, all_oxygen, nrow = 1, 
                  common.legend = T, align = 'h', 
                  legend = 'top', labels = 'auto')
```

